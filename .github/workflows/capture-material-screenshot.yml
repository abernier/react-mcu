name: Capture Material Theme Builder Screenshot

on:
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/capture-material-screenshot.yml"
  workflow_dispatch:
    inputs:
      source_color:
        description: "Source color (hex without #)"
        required: true
        default: "769CDF"

jobs:
  capture-screenshot:
    runs-on: ubuntu-latest

    steps:
      - name: Set source color
        id: color
        run: |
          # Use input color if provided (workflow_dispatch), otherwise use default
          SOURCE_COLOR="${{ github.event.inputs.source_color }}"
          if [ -z "$SOURCE_COLOR" ]; then
            SOURCE_COLOR="769CDF"
          fi
          echo "value=$SOURCE_COLOR" >> $GITHUB_OUTPUT
          echo "Using source color: $SOURCE_COLOR"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright
        run: |
          npm install -g playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Capture Material Theme Builder Screenshot
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const context = await browser.newContext({
              viewport: { width: 1920, height: 1080 }
            });
            
            const page = await context.newPage();
            
            // Navigate to Material Theme Builder
            console.log('Navigating to Material Theme Builder...');
            await page.goto('https://material-foundation.github.io/material-theme-builder/', {
              waitUntil: 'networkidle',
              timeout: 60000
            });
            
            // Wait for the page to be fully loaded
            await page.waitForTimeout(3000);
            
            // Try to find and click on the color input
            console.log('Looking for color input...');
            
            // The Material Theme Builder might have different selectors, try multiple approaches
            try {
              // Wait for any color input or picker to be visible
              await page.waitForSelector('input[type="color"], input[type="text"]', { timeout: 10000 });
              
              // Try to find the primary color input
              const colorInputs = await page.$$('input[type="color"], input[type="text"]');
              console.log(`Found ${colorInputs.length} inputs`);
              
              // Look for the main source color input (usually the first or most prominent)
              const sourceColorInput = colorInputs[0];
              if (sourceColorInput) {
                await sourceColorInput.click();
                await page.waitForTimeout(500);
                
                // Clear and type the color value
                await sourceColorInput.fill('');
                await sourceColorInput.type('${{ steps.color.outputs.value }}');
                await page.waitForTimeout(1000);
                
                // Press Enter to confirm
                await sourceColorInput.press('Enter');
                await page.waitForTimeout(2000);
              }
            } catch (error) {
              console.log('Could not automatically set color, capturing default view:', error.message);
            }
            
            // Take a full page screenshot
            console.log('Taking screenshot...');
            await page.screenshot({
              path: 'material-theme-builder-screenshot.png',
              fullPage: true
            });
            
            console.log('Screenshot saved successfully!');
            
            await browser.close();
          })();
          EOF

      - name: Commit screenshot
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add material-theme-builder-screenshot.png
          git commit -m "Add Material Theme Builder screenshot for comparison (source: #${{ steps.color.outputs.value }})" || echo "No changes to commit"
          git push

      - name: Comment on PR
        if: github.event_name == 'pull_request' || github.head_ref != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request?.number || 
                            context.payload.issue?.number;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âœ… Material Theme Builder screenshot has been captured and committed to the branch!\n\nSource color: #${{ steps.color.outputs.value }}\n\nThe screenshot is now available in `material-theme-builder-screenshot.png`.'
              });
            }
